<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>TV View - KTS Volley Scoreboard</title>
    <link rel="icon" href="icon.ico" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        /* === BASE === */
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background: #00b140; 
            font-family: 'Oswald', sans-serif; 
            transition: background 0.3s; 
        }

        /* === LOGO EVENTO === */
        .tv-comp-logo { 
            position: fixed; top: 40px; right: 40px; 
            height: 120px; 
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); 
            z-index: 50; 
        }

        /* === CONTAINER === */
        .tv-layer { 
            position: fixed; inset: 0; 
            display: flex; flex-direction: column; 
            justify-content: flex-end; align-items: center; 
            padding-bottom: 130px; 
            pointer-events: none; 
        }

        .board-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === VARIABILI STILE "LIQUID GLASS" === */
        :root {
            --glass-base-color: rgba(20, 20, 20, 0.60); 
            --glass-blur: blur(50px) saturate(200%);
            --glass-border: 1px solid rgba(255,255,255,0.35);
            --glass-shine: 1px solid rgba(255,255,255,0.7);
        }

        /* Mixin Materiale */
        .liquid-material {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, var(--glass-base-color) 40%, rgba(0,0,0,0.4) 100%);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
        }

        /* === MAIN BOARD === */
        .score-board {
            display: flex;
            align-items: stretch;
            height: 130px; 
            width: auto;
            min-width: 1050px;
            border-radius: 90px; 
            border-top: var(--glass-shine);
            position: relative;
            z-index: 10;
        }

        /* === BLOCCO SQUADRA === */
        .team-block { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            padding: 0 50px; 
            gap: 25px;
            min-width: 380px;
            position: relative;
        }
        .team-block.right { flex-direction: row-reverse; text-align: right; }

        .color-pill { 
            position: absolute; 
            top: 15px; bottom: 15px; 
            width: 8px; 
            border-radius: 10px; 
            box-shadow: 0 0 20px currentColor; 
        }
        .team-block.left .color-pill { left: 30px; }
        .team-block.right .color-pill { right: 30px; }

        .team-logo { 
            height: 100px; width: 100px; 
            object-fit: contain; 
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6)); 
        }

        /* MODIFICATO: NOME DINAMICO */
        .team-name { 
            flex: 1;
            font-size: 50px; /* Dimensione MAX iniziale */
            font-weight: 600; 
            color: #fff; 
            text-transform: uppercase; 
            white-space: nowrap; /* Forza su una riga */
            overflow: hidden; 
            /* text-overflow: ellipsis; RIMOSSO per permettere ridimensionamento */
            line-height: 1.1;
            margin-top: -5px;
            text-shadow: 0 2px 12px rgba(0,0,0,0.9);
            transform-origin: left center;
        }
        .team-block.right .team-name { transform-origin: right center; }

        /* === BADGE TANGENTI === */
        .attached-badge {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            height: 55px; 
            padding: 0 25px; 
            z-index: 5; 
        }
        
        .attached-badge.top { 
            top: -58px; 
            border-radius: 20px 20px 0 0; 
            border-bottom: var(--glass-border); 
            padding-bottom: 0;
            border-top: var(--glass-shine);
        }
        
        .attached-badge.bottom { 
            bottom: -58px; 
            border-radius: 0 0 20px 20px; 
            border-top: var(--glass-border); 
            padding-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.15); 
        }
        
        .team-block.left .attached-badge { left: 170px; }
        .team-block.right .attached-badge { right: 170px; flex-direction: row-reverse; }

        .bdg-lbl {
            font-family: 'Roboto', sans-serif;
            font-size: 28px; 
            font-weight: 900;
            color: #fff; 
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            margin-right: 5px;
        }
        .team-block.right .bdg-lbl { margin-right: 0; margin-left: 5px; }

        .bdg-content { display: flex; align-items: center; gap: 8px; }
        
        .ind-to { 
            width: 55px; height: 12px; 
            background: rgba(255,255,255,0.15); 
            border-radius: 4px; 
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.3);
        }
        .ind-to.active { background: #ff3b30; box-shadow: 0 0 20px #ff3b30; border-color: #ffb3b3; }

        .ind-sub {
            width: 15px; height: 15px; 
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            margin: 0 3px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .ind-sub.active { background: #ffcc00; box-shadow: 0 0 15px #ffcc00; border-color: #fff; }

        /* === PUNTEGGIO === */
        .score-box {
            width: 150px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2);
            position: relative;
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .score-val {
            font-family: 'Roboto', sans-serif;
            font-size: 100px; 
            font-weight: 800;
            color: #fff;
            line-height: 1;
            z-index: 2;
            text-shadow: 0 5px 30px rgba(0,0,0,0.6);
            letter-spacing: -4px;
        }
        .srv-bar {
            position: absolute; bottom: 0; width: 100%; height: 8px;
            background: #f1c40f;
            box-shadow: 0 -2px 20px rgba(241,196,15,0.8);
            transform: scaleX(0); transition: 0.3s;
        }
        .active-srv .srv-bar { transform: scaleX(1); animation: srvPulse 2s infinite; }
        @keyframes srvPulse { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 -2px 30px rgba(241,196,15,1); } 100% { opacity: 0.8; } }

        /* === SETS === */
        .sets-box {
            width: 120px;
            background: rgba(255,255,255,0.05);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .sets-lbl { font-size: 20px; color: #bbb; letter-spacing: 2px; font-weight: 700; text-transform: uppercase; margin-bottom: -5px; }
        .sets-val { font-size: 63px; color: #f1c40f; font-weight: 800; font-family: 'Roboto', sans-serif; line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.5);}

        /* === ADS WINGS === */
        .ad-wing {
            position: absolute; bottom: 0; height: 240px; width: 400px;
            background: transparent; display: flex; align-items: center; justify-content: center; 
            padding: 0; opacity: 0; transform: scale(0.9) translateX(0); 
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 5;
        }
        .ad-wing.left { right: 100%; margin-right: 25px; transform-origin: right center; justify-content: flex-end; }
        .ad-wing.right { left: 100%; margin-left: 25px; transform-origin: left center; justify-content: flex-start; }
        .ad-wing.show { opacity: 1; transform: scale(1) translateX(0); }
        .ad-wing-img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 5px 20px rgba(0,0,0,0.6)); }

        /* === OVERLAYS === */
        .fs-overlay { position: fixed; inset: 0; background: rgba(5,5,5,0.92); backdrop-filter: blur(15px); display: flex; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 100; align-items: center; justify-content: center; }
        .fs-overlay.active { opacity: 1; }
        .ov-grid { display: grid; grid-template-columns: 1fr 1fr; width: 85%; max-width: 1500px; gap: 80px; align-items: center; }
        .ov-grid.single { grid-template-columns: 1fr; text-align: center; }
        .ov-left { display: flex; flex-direction: column; justify-content: center; }
        .ov-right { display: flex; justify-content: center; align-items: center; }
        .ov-img { max-width: 100%; max-height: 50vh; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.5)); }
        .ov-tit { font-size: 55px; color: #f1c40f; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 3px; }
        .ov-time { font-size: 180px; color: #fff; font-family: 'Roboto', monospace; font-weight: 700; line-height: 0.9; margin-bottom: 40px; text-shadow: 0 0 40px rgba(255,255,255,0.15); }
        .ov-tbl { width: 100%; border-collapse: collapse; color: #eee; font-size: 28px; margin-top: 30px; }
        .ov-tbl th { text-align: left; color: #888; border-bottom: 1px solid #444; padding: 15px; font-weight: 600; text-transform: uppercase; font-size: 22px; }
        .ov-tbl td { padding: 20px 15px; border-bottom: 1px solid #333; }
        .ov-hl { color: #f1c40f; font-weight: bold; }
        .win-box { border: 3px solid #f1c40f; padding: 60px 120px; background: #000; text-align: center; border-radius: 30px; box-shadow: 0 0 120px rgba(241,196,15,0.3); }
        .win-txt { font-size: 70px; color: #fff; font-weight: 700; text-transform: uppercase; letter-spacing: 5px; }
        .win-sub { font-size: 90px; color: #f1c40f; margin-top: 10px; display: block; font-weight: 900; text-transform: uppercase; }

    </style>
</head>
<body>

    <div id="fs_ov" class="fs-overlay">
        <div id="ov_cont" class="ov-grid">
            <div class="ov-left">
                <div class="ov-tit" id="ov_tit">TIMEOUT</div>
                <div class="ov-time" id="ov_time">00:00</div>
                <div id="ov_det"></div> 
            </div>
            <div class="ov-right" id="ov_sp"></div>
        </div>
    </div>

    <div id="win_ov" class="fs-overlay">
        <div class="win-box">
            <div class="win-txt">VITTORIA</div>
            <span class="win-sub" id="win_name">TEAM NAME</span>
        </div>
    </div>

    <img id="comp_logo" class="tv-comp-logo">

    <div class="tv-layer">
        
        <div class="board-wrapper">
            
            <div id="ad_left" class="ad-wing left"><img id="img_ad_l" class="ad-wing-img"></div>

            <div class="score-board liquid-material" id="board">
                
                <div class="team-block left" id="tb_h">
                    <div class="attached-badge top liquid-material">
                        <span class="bdg-lbl">TO</span>
                        <div class="bdg-content">
                            <div class="ind-to" id="to_h_1"></div><div class="ind-to" id="to_h_2"></div>
                        </div>
                    </div>
                    <div class="color-pill" id="col_h"></div>
                    <img id="logo_h" class="team-logo">
                    <div id="name_h" class="team-name">HOME TEAM</div>
                    <div class="attached-badge bottom liquid-material">
                        <span class="bdg-lbl">SUB</span>
                        <div class="bdg-content">
                            <div class="ind-sub" id="sb_h_1"></div><div class="ind-sub" id="sb_h_2"></div>
                            <div class="ind-sub" id="sb_h_3"></div><div class="ind-sub" id="sb_h_4"></div>
                            <div class="ind-sub" id="sb_h_5"></div><div class="ind-sub" id="sb_h_6"></div>
                        </div>
                    </div>
                </div>

                <div class="score-box" id="sc_box_h">
                    <span class="score-val" id="score_h">0</span>
                    <div class="srv-bar"></div>
                </div>

                <div class="sets-box">
                    <div class="sets-lbl">SETS</div>
                    <div class="sets-val" id="sets_val">0-0</div>
                </div>

                <div class="score-box" id="sc_box_g">
                    <span class="score-val" id="score_g">0</span>
                    <div class="srv-bar"></div>
                </div>

                <div class="team-block right" id="tb_g">
                    <div class="attached-badge top liquid-material">
                        <span class="bdg-lbl">TO</span>
                        <div class="bdg-content">
                            <div class="ind-to" id="to_g_1"></div><div class="ind-to" id="to_g_2"></div>
                        </div>
                    </div>
                    <div class="color-pill" id="col_g"></div>
                    <img id="logo_g" class="team-logo">
                    <div id="name_g" class="team-name">GUEST TEAM</div>
                    <div class="attached-badge bottom liquid-material">
                        <span class="bdg-lbl">SUB</span>
                        <div class="bdg-content">
                            <div class="ind-sub" id="sb_g_1"></div><div class="ind-sub" id="sb_g_2"></div>
                            <div class="ind-sub" id="sb_g_3"></div><div class="ind-sub" id="sb_g_4"></div>
                            <div class="ind-sub" id="sb_g_5"></div><div class="ind-sub" id="sb_g_6"></div>
                        </div>
                    </div>
                </div>

            </div>

            <div id="ad_right" class="ad-wing right"><img id="img_ad_r" class="ad-wing-img"></div>

        </div>
    </div>

    <script src="http://localhost:5050/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:5050');
        
        let adImages = [];
        let midIdx = 0;
        let ovSpInt = null;
        let lastData = null;

        // --- MIDGAME ADS ---
        setInterval(() => {
            if(!lastData || !lastData.config.tvMidgameAds || !adImages.length) return;
            if(document.querySelector('.fs-overlay.active')) return;
            
            const leftBox = document.getElementById('ad_left');
            const rightBox = document.getElementById('ad_right');
            const now = Date.now();
            if(!window.lastAdShow || now - window.lastAdShow > 45000) {
                window.lastAdShow = now;
                document.getElementById('img_ad_l').src = adImages[midIdx];
                midIdx = (midIdx+1)%adImages.length;
                leftBox.classList.add('show');
                if(adImages.length > 1) {
                    document.getElementById('img_ad_r').src = adImages[midIdx];
                    midIdx = (midIdx+1)%adImages.length;
                    rightBox.classList.add('show');
                } else { rightBox.classList.remove('show'); }
                setTimeout(() => { leftBox.classList.remove('show'); rightBox.classList.remove('show'); }, 10000);
            }
        }, 5000);

        // --- UPDATE DISPLAY ---
        socket.on('update_display', d => {
            lastData = d;
            adImages = d.config.adImages || [];
            
            // BG & Logo
            const bg = d.config.tvBgColor;
            document.body.style.background = (bg==='blue')?'#0047bb':(bg==='black')?'#000':(bg==='transparent')?'transparent':'#00b140';
            const cl = document.getElementById('comp_logo');
            cl.src = d.config.compLogo||''; cl.style.display=d.config.compLogo?'block':'none';

            // Teams
            upTeam('h', d.home, d.rules.maxSubs);
            upTeam('g', d.guest, d.rules.maxSubs);
            
            document.getElementById('sets_val').innerText = `${d.home.sets}-${d.guest.sets}`;
            document.getElementById('sc_box_h').classList.toggle('active-srv', d.serving==='home');
            document.getElementById('sc_box_g').classList.toggle('active-srv', d.serving==='guest');

            // Winner
            const wOv = document.getElementById('win_ov');
            if(d.matchEnded && d.winner) {
                document.getElementById('win_name').innerText = d[d.winner].name;
                wOv.classList.add('active');
            } else { wOv.classList.remove('active'); }
        });

        function upTeam(s, t, maxS) {
            const nameEl = document.getElementById(`name_${s}`);
            
            // 1. Reset e Set Testo
            nameEl.innerText = t.name;
            nameEl.style.fontSize = '50px'; // Reset al massimo prima di calcolare

            document.getElementById(`score_${s}`).innerText = t.score;
            document.getElementById(`col_${s}`).style.backgroundColor = t.color;
            document.getElementById(`col_${s}`).style.boxShadow = `0 0 15px ${t.color}`;
            
            const l=document.getElementById(`logo_${s}`); 
            l.src=t.logo||''; l.style.display=t.logo?'block':'none';
            
            // Timeouts & Subs
            for(let i=1; i<=2; i++) document.getElementById(`to_${s}_${i}`).classList.toggle('active', i<=t.timeouts);
            for(let i=1; i<=6; i++) document.getElementById(`sb_${s}_${i}`).classList.toggle('active', i<=t.subs);

            // 2. Adjust Font Size (TV Logic: Single Line)
            adjustFontSize(nameEl, 50, 20);
        }

        // Ridimensiona il testo per stare in una riga
        function adjustFontSize(el, maxSize, minSize) {
            let currentSize = maxSize;
            el.style.fontSize = currentSize + 'px';
            
            // ScrollWidth è la larghezza reale del contenuto, clientWidth è lo spazio disponibile
            while (el.scrollWidth > el.clientWidth && currentSize > minSize) {
                currentSize--;
                el.style.fontSize = currentSize + 'px';
            }
        }

        // --- OVERLAYS ---
        socket.on('timer_update', t => {
            const ov = document.getElementById('fs_ov');
            const grid = document.getElementById('ov_cont');
            
            if(t.active && t.visible!==false) {
                ov.classList.add('active');
                const min = Math.floor(t.seconds/60);
                const sec = t.seconds%60;
                document.getElementById('ov_time').innerText = `${min}:${sec<10?'0'+sec:sec}`;
                document.getElementById('ov_tit').innerText = t.label || (t.type==='timeout'?'TIMEOUT':'');

                const det = document.getElementById('ov_det');
                if(t.type==='timeout' && lastData) {
                    const srv = lastData.serving ? lastData[lastData.serving].name : '-';
                    det.innerHTML = `
                        <div style="margin-bottom:20px; color:#aaa; font-size:24px;">AL SERVIZIO: <span class="ov-hl">${srv}</span></div>
                        <table class="ov-tbl">
                            <tr><th>STATISTICHE</th><th>${lastData.home.name}</th><th>${lastData.guest.name}</th></tr>
                            <tr><td>TIMEOUT</td><td class="ov-hl">${lastData.home.timeouts}</td><td class="ov-hl">${lastData.guest.timeouts}</td></tr>
                            <tr><td>SOSTITUZIONI</td><td>${lastData.home.subs}</td><td>${lastData.guest.subs}</td></tr>
                        </table>`;
                } else if(t.type==='interval' && lastData) {
                    let rows = '';
                    lastData.home.setScores.forEach((sh, i) => {
                        const sg = lastData.guest.setScores[i];
                        rows += `<tr><td>SET ${i+1}</td><td class="${sh>sg?'ov-hl':''}">${sh}</td><td class="${sg>sh?'ov-hl':''}">${sg}</td></tr>`;
                    });
                    det.innerHTML = `<table class="ov-tbl"><tr><th>STORICO SET</th><th>${lastData.home.name}</th><th>${lastData.guest.name}</th></tr>${rows}</table>`;
                }

                const sp = document.getElementById('ov_sp');
                if(adImages.length > 0) {
                    grid.classList.remove('single');
                    sp.style.display = 'flex';
                    if(!ovSpInt) {
                        let i=0;
                        const run = ()=>{ sp.innerHTML=`<img src="${adImages[i]}" class="ov-img">`; i=(i+1)%adImages.length; };
                        run();
                        ovSpInt = setInterval(run, 5000);
                    }
                } else {
                    grid.classList.add('single');
                    sp.style.display = 'none';
                    if(ovSpInt) { clearInterval(ovSpInt); ovSpInt=null; }
                }
            } else {
                ov.classList.remove('active');
                if(ovSpInt) { clearInterval(ovSpInt); ovSpInt=null; }
            }
        });
    </script>
</body>
</html>